{
    "name": "PL_Stage_NycTaxi",
    "properties": {
      "parameters": {
        "ingest_date": { "type": "String" }
      },
      "activities": [
        {
          "name": "ListFiles",
          "type": "GetMetadata",
          "dependsOn": [],
          "policy": { "timeout": "7.00:00:00", "retry": 1 },
          "typeProperties": { "dataset": { "referenceName": "DS_Parquet_NycTaxi", "type": "DatasetReference" }, "fieldList": ["childItems"] }
        },
        {
          "name": "ForEachFile",
          "type": "ForEach",
          "typeProperties": {
            "items": "@activity('ListFiles').output.childItems",
            "activities": [
              {
                "name": "CopyToStaging",
                "type": "Copy",
                "typeProperties": {
                  "source": { "type": "ParquetSource" },
                  "sink": {
                    "type": "SqlSink",
                    "preCopyScript": "DELETE FROM stg.trip WHERE ingest_date = @{pipeline().parameters.ingest_date};",
                    "writeBatchSize": 10000,
                    "writeBatchTimeout": "00:10:00",
                    "additionalColumns": [
                      { "name": "ingest_date", "value": "@{pipeline().parameters.ingest_date}" },
                      { "name": "source_file_name", "value": "@{item().name}" },
                      { "name": "loaded_at", "value": "@{utcNow()}" }
                    ]
                  },
                  "enableStaging": false
                },
                "inputs": [
                  {
                    "referenceName": "DS_Parquet_NycTaxi",
                    "type": "DatasetReference",
                    "parameters": {
                      "folder": "raw/nyc_taxi/ingest_date=@{pipeline().parameters.ingest_date}",
                      "fileName": "@{item().name}"
                    }
                  }
                ],
                "outputs": [ { "referenceName": "DS_Sql_StgTrip", "type": "DatasetReference" } ]
              }
            ]
          }
        }
      ]
    }
  }
  